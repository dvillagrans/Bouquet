<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .connecting {
            background-color: #fff3cd;
            color: #856404;
        }

        .log {
            background-color: #f8f9fa;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
        }

        input {
            padding: 10px;
            margin: 5px;
            width: 300px;
        }
    </style>
</head>

<body>
    <h1>WebSocket Test para Bouquet</h1>

    <div id="status" class="status disconnected">Desconectado</div>

    <div>
        <input type="text" id="url" value="ws://localhost:8000/ws" placeholder="WebSocket URL">
        <button onclick="connect()">Conectar</button>
        <button onclick="disconnect()">Desconectar</button>
    </div>

    <div>
        <input type="text" id="message" placeholder="Mensaje de prueba">
        <button onclick="sendMessage()">Enviar Mensaje</button>
    </div>

    <div>
        <button onclick="sendPing()">Enviar Ping</button>
        <button onclick="joinSession()">Unirse a Sesi√≥n de Prueba</button>
        <button onclick="clearLog()">Limpiar Log</button>
    </div>

    <div id="log" class="log"></div>

    <script>
        let ws = null;
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateStatus(status, className) {
            statusEl.textContent = status;
            statusEl.className = `status ${className}`;
        }

        function connect() {
            const url = document.getElementById('url').value;

            try {
                updateStatus('Conectando...', 'connecting');
                log(`Intentando conectar a: ${url}`);

                ws = new WebSocket(url);

                ws.onopen = function (event) {
                    updateStatus('Conectado', 'connected');
                    log('‚úÖ WebSocket conectado exitosamente');
                };

                ws.onmessage = function (event) {
                    log(`üì• Mensaje recibido: ${event.data}`);
                    try {
                        const data = JSON.parse(event.data);
                        log(`üìã Mensaje parseado: ${JSON.stringify(data, null, 2)}`);
                    } catch (e) {
                        log(`‚ö†Ô∏è No se pudo parsear como JSON: ${e.message}`);
                    }
                };

                ws.onclose = function (event) {
                    updateStatus('Desconectado', 'disconnected');
                    log(`‚ùå WebSocket cerrado: c√≥digo ${event.code}, raz√≥n: ${event.reason}`);
                };

                ws.onerror = function (error) {
                    updateStatus('Error', 'disconnected');
                    log(`üö® Error de WebSocket: ${error}`);
                };

            } catch (error) {
                updateStatus('Error', 'disconnected');
                log(`üí• Error al crear WebSocket: ${error.message}`);
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendMessage() {
            const message = document.getElementById('message').value;
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
                log(`üì§ Mensaje enviado: ${message}`);
                document.getElementById('message').value = '';
            } else {
                log('‚ùå WebSocket no est√° conectado');
            }
        }

        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const pingMessage = {
                    type: 'ping',
                    timestamp: new Date().toISOString()
                };
                ws.send(JSON.stringify(pingMessage));
                log(`üèì Ping enviado`);
            } else {
                log('‚ùå WebSocket no est√° conectado');
            }
        }

        function joinSession() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const joinMessage = {
                    type: 'join_session',
                    session_id: 'test-session-123',
                    user_type: 'waiter',
                    user_id: 'test-waiter-1'
                };
                ws.send(JSON.stringify(joinMessage));
                log(`üö™ Enviando solicitud para unirse a sesi√≥n de prueba`);
            } else {
                log('‚ùå WebSocket no est√° conectado');
            }
        }

        function clearLog() {
            logEl.innerHTML = '';
        }

        // Auto conectar al cargar la p√°gina
        window.onload = function () {
            log('P√°gina cargada. Haz clic en "Conectar" para probar WebSocket.');
        };
    </script>
</body>

</html>